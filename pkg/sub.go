package cbound

import (
	"fmt"
	"flag"
	"strings"
	"strconv"
	"github.com/jgbaldwinbrown/csvh"
	"io"
	"os"
	"bufio"
	"log"
)

type Span struct {
	Chr string
	Start int
	End int
}

type GenoSpan struct {
	Geno string
	Span
}

type Omap[K comparable, V any] struct {
	Keys []K
	M map[K]V
}

func NewOmap[K comparable, V any]() *Omap[K, V] {
	return &Omap[K, V]{M: map[K]V{}}
}

func (m *Omap[K, V]) Add(k K, v V) {
	if _, ok := m.M[k]; !ok {
		m.Keys = append(m.Keys, k)
	}
	m.M[k] = v
}

func SplitChrGeno(cg []string) (chr, geno string) {
	if len(cg) < 2 {
		return cg[0], ""
	}
	return cg[0], cg[1]
}

func ParseLine(line []string, col map[string]int) (GenoSpan, float64, bool, error) {
	h := csvh.Handle3[GenoSpan, float64, bool]("ParseLine: %w")

	if line[col["is_bad_bin"]] == "True" {
		return GenoSpan{}, 0, false, nil
	}

	chrgeno := strings.Split(line[col["chrom"]], "_")
	chr, geno := SplitChrGeno(chrgeno)

	start, e := strconv.Atoi(line[col["start"]])
	if e != nil {
		return h(e)
	}

	end, e := strconv.Atoi(line[col["end"]])
	if e != nil {
		return h(e)
	}

	ins, e := strconv.ParseFloat(line[col["log2_insulation_score_300000"]], 64)
	if e != nil {
		return h(e)
	}

	return GenoSpan{geno, Span{chr, start, end}}, ins, true, nil
}

func RunSubs(w io.Writer, r io.Reader, g1, g2 string) error {
	h := csvh.Handle0("RunSubs: %w")

	s, e := ParseInfo(r)
	if e != nil {
		return h(e)
	}

	subs := CalcSubs(s, g1, g2)
	if e := WriteSubs(w, subs); e != nil {
		return h(e)
	}

	return nil
}

func ParseInfo(r io.Reader) (*Omap[GenoSpan, float64], error) {
	i := 0
	h := func(e error) (*Omap[GenoSpan, float64], error) {
		return nil, fmt.Errorf("ParseInfo: line %v: %w", i, e)
	}

	cr := csvh.CsvIn(r)
	l, e := cr.Read()
	if e != nil {
		return h(e)
	}

	icol := csvh.NamesToCols(l)
	s := NewOmap[GenoSpan, float64]()

	for {
		l, e = cr.Read()
		if e == io.EOF {
			break
		} else if e != nil {
			return h(e)
		}

		span, val, ok, e := ParseLine(l, icol)
		if e != nil {
			return h(e)
		}
		if ok {
			s.Add(span, val)
		}

		i++
	}

	return s, nil
}

func CalcSubs(sps *Omap[GenoSpan, float64], g1, g2 string) *Omap[Span, float64] {
	subs := NewOmap[Span, float64]()
	for _, gspan := range sps.Keys {
		v1, ok := sps.M[gspan]
		if !ok || gspan.Geno != g1 {
			continue
		}
		gspan2 := gspan
		gspan2.Geno = g2

		v2, ok := sps.M[gspan2]
		if !ok {
			continue
		}
		subs.Add(gspan.Span, v1 - v2)
	}
	return subs
}

func WriteSubs(w io.Writer, subs *Omap[Span, float64]) error {
	for _, sp := range subs.Keys {
		v := subs.M[sp]
		_, e := fmt.Fprintf(w, "%v\t%v\t%v\t%v\n", sp.Chr, sp.Start, sp.End, v)
		if e != nil {
			return fmt.Errorf("WriteSubs: %w", e)
		}
	}
	return nil
}

func RunSubsFull() {
	r := bufio.NewReader(os.Stdin)
	w := bufio.NewWriter(os.Stdout)
	defer w.Flush()

	g1p := flag.String("g1", "", "First genotype")
	g2p := flag.String("g2", "", "Second genotype")
	flag.Parse()

	if *g1p == "" {
		log.Fatal("Missing -g1")
	}
	if *g2p == "" {
		log.Fatal("Missing -g2")
	}

	e := RunSubs(w, r, *g1p, *g2p)
	if e != nil {
		log.Fatal(e)
	}
}

// nxw_adult_to_nxwref_1kb_U00096.3:1:4641652_5000_boundaries.txt
// chrom	start	end	region	is_bad_bin	log2_insulation_score_3000	n_valid_pixels_3000	log2_insulation_score_5000	n_valid_pixels_5000	log2_insulation_score_10000	n_valid_pixels_10000	log2_insulation_score_25000	n_valid_pixels_25000	boundary_strength_3000	boundary_strength_10000	boundary_strength_5000	boundary_strength_25000	is_boundary_3000	is_boundary_5000	is_boundary_10000	is_boundary_25000
// U00096.3	5000	6000	U00096.3	False		6.0	-1.0370023869617397	22.0	-0.6531157723760652	57.0	-0.22282537137723113	141.0			1.2843294551078395		False	True	False	False
// U00096.3	9000	10000	U00096.3	False	-1.3895839967738095	6.0	-0.8720636406997614	22.0	0.06584614009466166	87.0	-0.1887325371379575	237.0	0.5077724440741064		0.3432666444374952		False	False	False	False
// U00096.3	11000	12000	U00096.3	False	-1.408528747084329	6.0	-0.7838642614493591	17.0	-0.4305802080118349	87.0	-0.43249899460371616	285.0	0.7262187908487235		0.13913785603099316		False	False	False	False
// U00096.3	14000	15000	U00096.3	False	-1.4355473643185828	4.0	-2.0669021088632666	18.0	0.05752474875841155	88.0	0.0022919647220435227	358.0	4.363377308689217		4.378340058761959		True	True	False	False
// U00096.3	21000	22000	U00096.3	False		6.0	-1.4212265620576194	22.0	-1.0762278797340872	87.0	-0.29195522250271894	522.0		1.3204250980407228	2.2442130039682797	0.2071892514450244	False	True	True	False
// U00096.3	27000	28000	U00096.3	False	1.2084011288468832	6.0	0.13566132604460196	22.0	-0.5472605541719323	97.0	-0.277414252313052	597.0		0.351587302131353	0.5856146691614013	0.041429181042940466	False	False	False	False
// U00096.3	30000	31000	U00096.3	False	0.21784021937706755	6.0	-0.12685245005401766	22.0	-0.6346182163025954	97.0	-0.4882075873385028	597.0		0.25773255719804883	0.2213255839362272	0.037969203826430986	False	False	False	False
// U00096.3	33000	34000	U00096.3	False	0.07287845415259857	6.0	-0.5505629756037808	22.0	-0.9793175172289416	97.0	-0.4765830096750863	597.0			0.1734374367041293		False	False	False	False
// U00096.3	38000	39000	U00096.3	False	0.017698029283260457	6.0	-1.4880297241262157	22.0	-1.250633223772062	97.0	-0.2567323774260819	597.0			2.1367023292770986		False	True	False	False
// 

// chrom	start	end	region	is_bad_bin	log2_insulation_score_300000	n_valid_pixels_300000	log2_insulation_score_500000	n_valid_pixels_500000	log2_insulation_score_1000000	n_valid_pixels_1000000	log2_insulation_score_2500000	n_valid_pixels_2500000	boundary_strength_300000	boundary_strength_500000	boundary_strength_1000000	boundary_strength_2500000	is_boundary_300000	is_boundary_500000	is_boundary_1000000	is_boundary_2500000
// 3R_W501	4700000	4800000	3R_W501	False	-0.8968926031143847	6.0	-0.3643022589727047	22.0	0.20288591908900655	67.0	0.29678949227182083	165.0	2.0879687217121594	0.41740674812515266			True	False	False	False
// 3R_W501	5200000	5300000	3R_W501	False	-0.5357430568922338	6.0	-0.31114448444259957	22.0	-0.1646518868026196	87.0	0.4101297029213288	285.0	0.45769399727671034				False	False	False	False
// 3R_W501	5800000	5900000	3R_W501	True	-0.7594978927673843	4.0	-0.6142418189755117	16.0	-0.23014467457062399	81.0	0.42315797179575654	408.0	1.137939017980668	1.6160766668631694	0.08529174978507967		True	True	False	False
// 3R_W501	6300000	6400000	3R_W501	False	-0.03919868086977579	6.0	0.2731563281465414	22.0	0.24094968974852984	87.0	0.266997119715429	547.0	1.0472779727140311		0.1566744071777393		True	False	False	False
// 3R_W501	7100000	7200000	3R_W501	False	-0.33780208413942175	6.0	-0.10629315968519093	22.0	0.12368152729264253	97.0	-0.7130505533839898	597.0	1.307243772752857	0.8323979533308911	0.10706300509346506	0.024872365140466757	True	True	False	False
// 3R_W501	8000000	8100000	3R_W501	False	-2.437209675504382	6.0	-2.440607931552646	22.0	-2.417812589693914	97.0	-2.337551121592013	597.0	4.267556921257186	4.161501591432909	4.047813566344422	3.4415241529073324	True	True	True	True
// 3R_W501	8700000	8800000	3R_W501	False	-0.6483712625692412	6.0	-0.5113328401998364	22.0	-0.6144626557548447	97.0	-1.2628643234634542	622.0	0.1381049564413277				False	False	False	False
// 3R_W501	8900000	9000000	3R_W501	False	-0.7341450385633761	6.0	-0.532671694203537	22.0	-0.4384512909069417	97.0	-1.100376897022395	622.0	0.6991599006882753				True	False	False	False
// 3R_W501	9400000	9500000	3R_W501	False	-0.8729622233678056	6.0	-0.6324083500822704	22.0	-0.38320638970940296	97.0	-0.821026971650765	622.0	1.2353580591989408	0.6375455935412168	0.06777782304492536		True	True	False	False
// 3R_W501	9600000	9700000	3R_W501	False	-0.5418972078629708	6.0	-0.5286003399588274	22.0	-0.3676309435976756	97.0	-0.7458375855132293	622.0	0.02307781135250697		0.047447380187676136		False	False	False	False
// 3R_W501	10100000	10200000	3R_W501	False	-0.5754691911517541	6.0	-0.5486120971652043	22.0	-0.4718920528509912	97.0	-0.6789688796718393	622.0	0.4756838696755058	0.31591015193494676		0.014475380745973099	False	False	False	False
// 3R_W501	10800000	10900000	3R_W501	False	-0.47912295303328273	6.0	-0.1609348085446613	22.0	-0.22434726863517862	97.0	-0.6655131167374374	622.0	0.9699815174356194	0.3111291620160624		0.07251911173308812	True	False	False	False
// 3R_W501	11600000	11700000	3R_W501	False	-1.0353425012010562	6.0	-0.8392877869753679	22.0	-0.49822358250183085	97.0	-0.486527851545528	622.0	2.0494151480443525	1.4739229846139685	0.6191619895572767	0.009394148585580242	True	True	True	False
// 3R_W501	12400000	12500000	3R_W501	False	-0.25552051145625465	6.0	-0.06311545655133874	22.0	0.20490386027746896	97.0	0.52285167809084	622.0	1.0265732496344881	0.5340918524186784			True	True	False	False
// 3R_W501	13700000	13800000	3R_W501	False	-0.5377003486438653	6.0	-0.2346600334922565	22.0	-0.1508668947608019	97.0	0.4751257701049196	622.0	0.6383426609561381		0.04716827741798525		False	False	False	False
// 3R_W501	14100000	14200000	3R_W501	False	-0.3671666729218257	6.0	-0.23206677466394193	22.0	-0.1171248790365036	97.0	0.07924209073078634	622.0	0.3053110535042693	0.11818224656989616			False	False	False	False
// 3R_W501	14700000	14800000	3R_W501	False	-0.7511606394467082	6.0	-0.471499289362219	22.0	-0.3169321446463844	97.0	-0.22304049609011564	597.0	1.0485658191186271	0.4315311438494318	0.1713013810350954	0.023473514429368986	True	False	False	False
// 3R_W501	15200000	15300000	3R_W501	False	-1.0774874314993177	6.0	-0.7106288182949861	22.0	-0.3617198530395108	97.0	-0.29646437291982325	597.0	2.190768588957183	1.4296093353983954	0.6957377623199966	0.14542305779007836	True	True	True	False
// 3R_W501	15900000	16000000	3R_W501	False	-0.4553735589059614	6.0	-0.419095313313176	22.0	-0.1696371627811788	97.0	-0.28011373587675215	597.0	0.12402419110598906	1.0851927705370006	0.009141954864848978		False	True	False	False
// 3R_W501	16300000	16400000	3R_W501	False	-0.586377011498586	6.0	-0.24318831012403053	22.0	-0.0553990241511588	87.0	-0.31959202285525307	597.0	1.1851135428002428				True	False	False	False
// 3R_W501	17100000	17200000	3R_W501	True	-1.0181101565268555	4.0	-0.328945093962	16.0	-0.15323295098342538	81.0	-0.41896019322769074	576.0	1.8651716828539382	0.8350144116950262	0.39067963798534	0.12740548572084026	True	True	False	False
// 3R_W501	17600000	17700000	3R_W501	False	-0.2686795451744629	6.0	0.02372312614331301	22.0	0.04980349898931404	87.0	-0.35544717545797094	597.0	0.8347072240971464		0.1636112045466549	0.06029857821054774	True	False	False	False
// 3R_W501	18200000	18300000	3R_W501	False	-0.8928096505665872	6.0	-0.5982642689933346	22.0	-0.25506305649215183	97.0	-0.42251203352328254	573.0	1.5395950240432161	1.1132967751775218	0.5341253194147728	0.27909087237705266	True	True	True	False
// 3R_W501	18600000	18700000	3R_W501	False	0.06716845887411448	6.0	0.1250773589058623	22.0	-0.0277106004012319	97.0	-0.2896852077978208	549.0	0.13135486906167082				False	False	False	False
// 3R_W501	19000000	19100000	3R_W501	False	-0.6285211002278548	6.0	-0.39851253399334596	22.0	-0.17971577315944545	97.0	-0.3147138009488719	549.0	0.8611023174616522	0.5235898928992082	0.15200517275821354	0.03493181410242724	True	True	False	False
// 3R_W501	19900000	20000000	3R_W501	False	-0.3219785382472752	6.0	-0.11959430369331411	17.0	-0.08029608842976822	87.0	-0.2858165482441743	572.0	1.1049428435060102	0.07092741606726402	0.32228683791273127	0.053006782454522755	True	False	False	False
// 3R_W501	20600000	20700000	3R_W501	False	-0.36506316761768004	6.0	-0.06864282754168591	13.0	-0.22569329506580246	78.0	-0.4042040097185946	573.0	0.3994481133211584				False	False	False	False
// 3R_W501	21200000	21300000	3R_W501	False	-0.9893983529474258	6.0	-0.6594184868298423	17.0	-1.1003616498514368	87.0	-0.5401605018852016	572.0	0.8838111703315658		0.03627170024796733		True	False	False	False
// 3R_W501	21700000	21800000	3R_W501	False	-2.3140030037803387	6.0	-2.222244420347787	22.0	-2.106093861485972	87.0	-0.71774213812712	572.0	3.7749888717496667	3.912376859287117	3.73609483813648	0.06583203593227971	True	True	True	False
// 3R_W501	22400000	22500000	3R_W501	False	-0.5998303541734403	6.0	-0.3783608922427438	22.0	-0.45652487722711854	97.0	-0.4438851300814981	526.0	1.331596850107518	0.6610988736853949	0.13343031772407432		True	True	False	False
// 3R_W501	22600000	22700000	3R_W501	False	-0.597375686582519	6.0	-0.25637444067768134	22.0	-0.21759171684265413	97.0	-0.438410109135891	526.0	0.19951380541554314				False	False	False	False
// 3R_W501	23100000	23200000	3R_W501	False	-0.5377402064486506	6.0	-0.13143420314317303	22.0	-0.10595509092717484	97.0	-0.1563088592677489	549.0	0.7647344909699176				True	False	False	False
// 3R_W501	23800000	23900000	3R_W501	False	-0.6159590470817853	6.0	-0.6556191296958438	22.0	-0.3235459470277555	87.0	0.04337373309782238	547.0	0.21253783280811	1.0390687111899282	0.500134843610714	0.008784622486575439	False	True	True	False
// 3R_W501	24200000	24300000	3R_W501	False	-0.8682445275165265	4.0	-0.32301155194165093	18.0	-0.15970221721927044	78.0	0.12498125571961648	548.0	1.6498278403627311				True	False	False	False
// 3R_W501	24800000	24900000	3R_W501	True	-0.35207395032770017	4.0	-0.3672185816630273	16.0	-0.31769886909786005	72.0	0.09974452032234474	529.0	0.11282454067154984	0.044207029721376356	0.16365014559757582		False	False	False	False
// 3R_W501	25200000	25300000	3R_W501	False	-0.1409898198783634	6.0	0.10690216362047994	17.0	0.0847422386243596	69.0	0.20123828638485078	549.0	0.10830193522693539				False	False	False	False
// 3R_W501	25500000	25600000	3R_W501	False	0.15532523245441754	6.0	0.15978093063933002	22.0	0.170002116978912	78.0	0.2429289400710871	549.0	0.16297150972733437				False	False	False	False
// 3R_W501	26000000	26100000	3R_W501	True	-0.1411202438102598	4.0	-0.058905547248890286	16.0	0.010958691198731857	81.0	0.1877089410572525	528.0	0.528781944036842	0.42031504823223276	0.18243229143239206	0.07562800000638781	False	False	False	False
// 3R_W501	26500000	26600000	3R_W501	False	0.4590068240995909	6.0	0.4765772242785523	22.0	0.3070169468852671	87.0	0.25257278979672504	547.0	0.08465125734630552				False	False	False	False
// 3R_W501	26900000	27000000	3R_W501	False	-0.41516265849944406	6.0	-0.2455936176902447	22.0	-0.018651788886227465	87.0	0.1779985934127688	572.0	0.22826485338964622	0.9811007513787019		0.10435510239338441	False	True	False	False
// 3R_W501	27200000	27300000	3R_W501	False	-0.4190770087378272	6.0	-0.111650950029705	22.0	0.041601445679662744	97.0	0.22913283026516937	572.0	1.0952921682036176				True	False	False	False
// 3R_W501	27600000	27700000	3R_W501	False	0.2868513647820749	6.0	0.5390232824153423	22.0	0.5677491216134308	97.0	0.41382398669773823	597.0	0.3548051236078918	0.08117046991311572	0.03939064567795647		False	False	False	False
// 3R_W501	28100000	28200000	3R_W501	False	1.638611187545557	6.0	1.7208936598802627	22.0	1.2804346795484072	97.0	0.7149445528439052	573.0	0.0132668334328927				False	False	False	False
// 3R_W501	28600000	28700000	3R_W501	False	0.0026934395943029777	6.0	0.1432885177777187	22.0	0.4341661003727691	97.0	0.44934408190568115	597.0	0.22852103396908552		0.04728896416591194	0.010239077218088533	False	False	False	False
// 3R_W501	29100000	29200000	3R_W501	False	-0.19790265119293682	6.0	0.3527289261259136	22.0	0.33148701654877694	97.0	0.44652663679161225	597.0	0.7918080706185329				True	False	False	False
// 3R_W501	29700000	29800000	3R_W501	False	-0.6405064996672089	6.0	-0.4633174969696321	22.0	-0.04473437883796546	87.0	0.3463196435740247	522.0	2.4708537454200132	2.1842111568498948	1.3251690583863727	0.01574337511245527	True	True	True	False
// 3R_W501	30000000	30100000	3R_W501	False	-0.3178417822602154	6.0	-0.24884590803046192	17.0	-0.010148386038088026	87.0	0.2976619131610789	447.0	0.06919364407490586				False	False	False	False
// 3R_W501	31200000	31300000	3R_W501	False	0.14564776914877614	6.0	0.20777867302465194	22.0	0.34709867999835264	60.0	0.49548958194632253	165.0	0.19291183829459946				False	False	False	False
